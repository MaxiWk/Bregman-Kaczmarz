clear
clc

addpath(genpath('../'))

fprintf('\n Experiment Linear equations on probability simplex, influence of stepsize accuracy\n')


num_examples = 50;
writeout = true;

%% run experiments

% 1
disp('1/2')
solvers = {POCS_Simplex_Kaczmarz, ...
           rNBK_Simplex_Kaczmarz, ...
           NBK_Simplex_Kaczmarz(struct(...
           'make_projection_feasibility_check', true, ...
           'tol_linesearch', 1e-9, ...
           'linesearch_optimizer', 'Newton')), ...
           };
problem_data = struct( 'system_size', struct('n', 200, 'd', 500), ...                        
                       'A_distr', struct('type', 'uniform', 'min_A', 0, 'max_A', 1), ...   
                       'sol_distr', 'random_uniform', ...
                       'init_properties', struct('type', 'central') );       
iter_save_fig11 = 1e2;
experiment_fig1 = experiment( @linear_equations_on_probability_simplex, ...
                              problem_data, ...
                              solvers, ...
                              num_examples, ...
                              runtime_stopping(struct('iter_save', iter_save_fig11,...
                                                      'max_time', 2)), ...
                              {'residual'}, ...
                              1/problem_data.system_size.n * ones(1, problem_data.system_size.n), ...
                              struct( ...
                              'random_seed_for_problem', struct('start',0,'increment',1), ...
                              'random_seed_for_init', struct('start',0,'increment',1), ...
                              'random_seed_for_solvers', struct('start',0,'increment',1)));  
stats_fig1 = experiment_fig1.run(); 


% 2
disp('2/2')
solvers = {POCS_Simplex_Kaczmarz, ...
           rNBK_Simplex_Kaczmarz, ...
           NBK_Simplex_Kaczmarz(struct(...
           'make_projection_feasibility_check', true, ...
           'tol_linesearch', 1e-5, ...
           'linesearch_optimizer', 'Newton')), ...
           };
experiment_fig2 = experiment( @linear_equations_on_probability_simplex, ...
                              problem_data, ...
                              solvers, ...
                              num_examples, ...
                              runtime_stopping(struct('iter_save', iter_save_fig11, ...
                                                      'max_time', 2)), ...
                              {'residual'}, ...
                              1/problem_data.system_size.n * ones(1, problem_data.system_size.n), ...
                              struct( ...
                              'random_seed_for_problem', struct('start',0,'increment',1), ...
                              'random_seed_for_init', struct('start',0,'increment',1), ...
                              'random_seed_for_solvers', struct('start',0,'increment',1))); 
stats_fig2 = experiment_fig2.run(); 




%% generate plots

figure
subplot(1,2,1);
line_plots = plot_minmax_median_quantiles(stats_fig1.residual, solvers, ...
                                          stats_fig1.timegrid);                                                            
                                                                                            
xlabel('k');
ylabel('$$\|Ax_k-b\|/\|b\|$$', 'Interpreter', 'Latex', 'FontSize', 15);
legend(line_plots, 'NK', 'rNBK', 'NBK', 'location', 'west')

subplot(1,2,2);
line_plots = plot_minmax_median_quantiles(stats_fig2.residual, solvers, ...
                                          stats_fig2.timegrid);                                                            
                                                                                            
xlabel('k');
ylabel('$$\|Ax_k-b\|/\|b\|$$', 'Interpreter', 'Latex', 'FontSize', 15);
legend(line_plots, 'NK', 'rNBK', 'NBK', 'location', 'west')




%% writeout data

if writeout
    writeout_data_over_array_on_xaxis(... 
          '../../linear_equations_on_simplex/uniform_different_epsilons/fig1.txt', ...
          {'t','POCSmin','rNBKmin','NBKmin', 'POCSmax','rNBKmax','NBKmax', ...
               'POCSmedian','rNBKmedian','NBKmedian', ...
               'POCSquant25','rNBKquant25','NBKquant25', ...
               'POCSquant75','rNBKquant75','NBKquant75'}, ...
          stats_fig1.timegrid, ...
          [stats_fig1.residual.mins, ...
          stats_fig1.residual.maxs, ...
          stats_fig1.residual.medians, ...
          stats_fig1.residual.quant25s, ...
          stats_fig1.residual.quant75s]);
     writeout_data_over_array_on_xaxis(... 
          '../../linear_equations_on_simplex/uniform_different_epsilons/fig2.txt', ...
          {'t','POCSmin','rNBKmin','NBKmin', 'POCSmax','rNBKmax','NBKmax', ...
               'POCSmedian','rNBKmedian','NBKmedian', ...
               'POCSquant25','rNBKquant25','NBKquant25', ...
               'POCSquant75','rNBKquant75','NBKquant75'}, ...
          stats_fig2.timegrid, ...
          [stats_fig2.residual.mins, ...
          stats_fig2.residual.maxs, ...
          stats_fig2.residual.medians, ...
          stats_fig2.residual.quant25s, ...
          stats_fig2.residual.quant75s]);
end




